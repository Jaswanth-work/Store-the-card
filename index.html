<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Card Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: sans-serif;
            background-color: #1a1a2e;
            color: #fff;
        }
        .container {
            max-width: 90%;
            margin: auto;
            padding: 1rem;
        }
        .glass-card {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 9999px;
            color: white;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }
        .message-box.show {
            opacity: 1;
        }
        .message-box.success {
            background-color: #3b82f6;
        }
        .message-box.error {
            background-color: #ef4444;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">
    <div id="app" class="container">
        <!-- Login View -->
        <div id="loginView" class="w-full h-full flex flex-col items-center justify-center text-center">
            <header class="my-8">
                <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-600">
                    Login to Business Card Scanner
                </h1>
                <p class="text-gray-400 mt-2">Sign in with your phone number to get started.</p>
            </header>
            <div class="glass-card p-8 rounded-xl w-full max-w-sm">
                <div id="phoneInputContainer" class="space-y-4">
                    <input id="phoneNumberInput" type="tel" class="rounded-md p-3 w-full text-black placeholder-gray-400" placeholder="e.g., +1234567890">
                    <button id="sendOtpBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                        Send OTP
                    </button>
                </div>
                <div id="otpInputContainer" class="hidden space-y-4">
                    <input id="otpInput" type="number" class="rounded-md p-3 w-full text-black placeholder-gray-400" placeholder="Enter OTP">
                    <button id="verifyOtpBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                        Verify OTP
                    </button>
                </div>
                <div id="recaptcha-container" class="mt-4 flex justify-center"></div>
            </div>
        </div>

        <!-- Main Dashboard View -->
        <div id="dashboardView" class="hidden w-full">
            <header class="text-center my-8">
                <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-600">
                    Business Card Scanner
                </h1>
                <p class="text-gray-400 mt-2">Scan, save, and manage your contacts.</p>
            </header>

            <!-- User Info and Controls -->
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg mb-6 flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                <div class="text-center sm:text-left">
                    <p class="text-sm text-gray-400">Logged in as:</p>
                    <p id="userIdDisplay" class="font-mono text-xs text-blue-400 break-all"></p>
                </div>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                    <button id="viewFavoritesBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-full w-full sm:w-auto">
                        Favorites (<span id="favoritesCount">0</span>)
                    </button>
                    <button id="viewFoldersBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-full w-full sm:w-auto">
                        Folders
                    </button>
                </div>
            </div>
            
            <!-- Recent Scans Section -->
            <div class="mt-8">
                <h2 class="text-2xl font-semibold mb-4 text-purple-300">Recent Scans</h2>
                <div id="recentCardsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p id="noCardsMessage" class="text-gray-400 text-center mt-4">No cards have been scanned yet.</p>
                </div>
            </div>

            <!-- Floating Action Button -->
            <button id="scanFab" class="fixed bottom-8 right-8 bg-blue-600 hover:bg-blue-700 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg transition-transform transform hover:scale-110">
                <span class="text-3xl">+</span>
            </button>
        </div>

        <!-- Scan and Edit View -->
        <div id="scanView" class="hidden w-full">
            <header class="text-center my-8">
                <h2 class="text-3xl font-bold">Scan a Card</h2>
                <p class="text-gray-400 mt-2">Upload an image to extract details.</p>
            </header>

            <div class="card-upload-area text-center glass-card p-8 rounded-xl">
                <div class="flex items-center justify-center w-full">
                    <label for="imageUpload" class="flex flex-col items-center justify-center w-full h-40 border-2 border-dashed border-gray-600 rounded-lg cursor-pointer bg-gray-700 hover:bg-gray-600 transition-colors duration-200">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <svg class="w-8 h-8 mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            <p class="mb-2 text-sm text-gray-400"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                            <p class="text-xs text-gray-400">JPG, PNG</p>
                        </div>
                        <input id="imageUpload" type="file" class="hidden" accept="image/jpeg, image/png" />
                    </label>
                </div>

                <!-- Loading and Extracted Data -->
                <div id="loadingIndicator" class="hidden flex flex-col justify-center items-center my-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
                    <p id="loadingMessage" class="mt-4 text-gray-400">Analyzing card...</p>
                </div>

                <div id="extractedDataSection" class="hidden mt-6 text-left">
                    <h3 class="text-xl font-semibold mb-4 text-green-300">Extracted Details</h3>
                    <div id="cardDetailsContainer" class="space-y-3"></div>
                    <button id="saveCardBtn" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                        Save Card
                    </button>
                    <button id="cancelScanBtn" class="mt-3 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Favorites View -->
        <div id="favoritesView" class="hidden w-full">
            <header class="text-center my-8">
                <h2 class="text-3xl font-bold">Favorite Cards</h2>
            </header>
            <button id="backFromFavoritesBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg mb-4">
                &larr; Back to Dashboard
            </button>
            <div id="favoritesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <p id="noFavoritesMessage" class="text-gray-400 text-center mt-4">No cards have been marked as favorites yet.</p>
            </div>
        </div>

        <!-- Folders View -->
        <div id="foldersView" class="hidden w-full">
            <header class="text-center my-8">
                <h2 class="text-3xl font-bold">Company Folders</h2>
            </header>
            <button id="backFromFoldersBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg mb-4">
                &larr; Back to Dashboard
            </button>
            <div id="foldersList" class="space-y-6">
                <p id="noFoldersMessage" class="text-gray-400 text-center mt-4">No companies have been added yet.</p>
            </div>
        </div>
    </div>

    <!-- Message Box -->
    <div id="messageBox" class="message-box"></div>

    <script type="module">
        // Import Firebase libraries from CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, query, addDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // UI Elements
        const loginView = document.getElementById('loginView');
        const dashboardView = document.getElementById('dashboardView');
        const scanView = document.getElementById('scanView');
        const favoritesView = document.getElementById('favoritesView');
        const foldersView = document.getElementById('foldersView');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const favoritesCount = document.getElementById('favoritesCount');
        const recentCardsList = document.getElementById('recentCardsList');
        const noCardsMessage = document.getElementById('noCardsMessage');
        const favoritesList = document.getElementById('favoritesList');
        const noFavoritesMessage = document.getElementById('noFavoritesMessage');
        const foldersList = document.getElementById('foldersList');
        const noFoldersMessage = document.getElementById('noFoldersMessage');
        const scanFab = document.getElementById('scanFab');
        const viewFavoritesBtn = document.getElementById('viewFavoritesBtn');
        const viewFoldersBtn = document.getElementById('viewFoldersBtn');
        const backFromFavoritesBtn = document.getElementById('backFromFavoritesBtn');
        const backFromFoldersBtn = document.getElementById('backFromFoldersBtn');
        const imageUpload = document.getElementById('imageUpload');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const loadingMessage = document.getElementById('loadingMessage');
        const extractedDataSection = document.getElementById('extractedDataSection');
        const cardDetailsContainer = document.getElementById('cardDetailsContainer');
        const saveCardBtn = document.getElementById('saveCardBtn');
        const cancelScanBtn = document.getElementById('cancelScanBtn');
        const messageBox = document.getElementById('messageBox');
        
        // Login UI elements
        const phoneNumberInput = document.getElementById('phoneNumberInput');
        const sendOtpBtn = document.getElementById('sendOtpBtn');
        const otpInput = document.getElementById('otpInput');
        const verifyOtpBtn = document.getElementById('verifyOtpBtn');
        const phoneInputContainer = document.getElementById('phoneInputContainer');
        const otpInputContainer = document.getElementById('otpInputContainer');

        // State variables
        let db, auth, userId, confirmationResult;
        let extractedCardData = {};
        let allScannedCards = [];
        const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=';
        let recaptchaVerifier;

        // --- Firebase Initialization and Auth ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Listen for auth state changes to determine which view to show
                onAuthStateChanged(auth, user => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        setView('dashboard');
                        setupFirestoreListeners(userId);
                    } else {
                        // No user is signed in, show login view
                        setView('login');
                    }
                });
            } catch (error) {
                console.error("Firebase initialization or auth failed:", error);
                showMessage('Firebase initialization failed.', 'error');
            }
        }

        // --- Firebase Firestore Listeners ---
        function setupFirestoreListeners(currentUserId) {
            const cardsCollection = collection(db, `artifacts/${appId}/users/${currentUserId}/cards`);
            onSnapshot(cardsCollection, (snapshot) => {
                allScannedCards = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDashboard();
                renderFavorites();
                renderFolders();
            }, (error) => {
                console.error("Error fetching cards:", error);
                showMessage('Failed to load data.', 'error');
            });
        }

        // --- View Switching Logic ---
        function setView(view) {
            loginView.classList.add('hidden');
            dashboardView.classList.add('hidden');
            scanView.classList.add('hidden');
            favoritesView.classList.add('hidden');
            foldersView.classList.add('hidden');

            if (view === 'login') {
                loginView.classList.remove('hidden');
            } else if (view === 'dashboard') {
                dashboardView.classList.remove('hidden');
            } else if (view === 'scan') {
                scanView.classList.remove('hidden');
                // Reset form state
                imageUpload.value = '';
                extractedDataSection.classList.add('hidden');
            } else if (view === 'favorites') {
                favoritesView.classList.remove('hidden');
            } else if (view === 'folders') {
                foldersView.classList.remove('hidden');
            }
        }

        // --- UI Rendering ---
        function renderDashboard() {
            const recentCards = allScannedCards.slice(-3).reverse();
            recentCardsList.innerHTML = '';
            if (recentCards.length > 0) {
                noCardsMessage.classList.add('hidden');
                recentCards.forEach(card => renderCard(card, recentCardsList));
            } else {
                noCardsMessage.classList.remove('hidden');
            }
            favoritesCount.textContent = allScannedCards.filter(c => c.isFavorite).length;
        }

        function renderFavorites() {
            const favoriteCards = allScannedCards.filter(c => c.isFavorite);
            favoritesList.innerHTML = '';
            if (favoriteCards.length > 0) {
                noFavoritesMessage.classList.add('hidden');
                favoriteCards.forEach(card => renderCard(card, favoritesList));
            } else {
                noFavoritesMessage.classList.remove('hidden');
            }
        }

        function renderFolders() {
            const companies = allScannedCards.reduce((acc, card) => {
                const companyName = card.company || 'Uncategorized';
                if (!acc[companyName]) {
                    acc[companyName] = [];
                }
                acc[companyName].push(card);
                return acc;
            }, {});

            foldersList.innerHTML = '';
            const companyNames = Object.keys(companies).sort();
            if (companyNames.length > 0) {
                 noFoldersMessage.classList.add('hidden');
                 companyNames.forEach(companyName => {
                    const companyElement = document.createElement('div');
                    companyElement.className = 'glass-card p-4 rounded-xl mb-4';
                    const employeesHtml = companies[companyName].map(emp => `
                        <div class="mt-2 p-2 bg-gray-700 rounded-md">
                            <p class="font-semibold">${emp.name}</p>
                            <p class="text-sm text-gray-400">${emp.title}</p>
                        </div>
                    `).join('');
                    companyElement.innerHTML = `
                        <h3 class="text-xl font-bold mb-2">${companyName} (${companies[companyName].length})</h3>
                        ${employeesHtml}
                    `;
                    foldersList.appendChild(companyElement);
                 });
            } else {
                 noFoldersMessage.classList.remove('hidden');
            }
        }

        function renderCard(card, container) {
            const isFavorite = card.isFavorite;
            const favoriteIcon = `
                <button class="favorite-btn absolute top-3 right-3" data-id="${card.id}" data-isfavorite="${isFavorite}">
                    <svg class="w-6 h-6 transition-transform hover:scale-110" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path class="${isFavorite ? 'text-yellow-400' : 'text-gray-400'}" d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                    </svg>
                </button>
            `;
            const linkedinLink = card.linkedin ? `<a href="${card.linkedin}" target="_blank" class="text-blue-400 hover:underline">LinkedIn Profile</a>` : 'N/A';
            const cardElement = document.createElement('div');
            cardElement.className = 'glass-card p-6 rounded-xl relative';
            cardElement.innerHTML = `
                ${favoriteIcon}
                <h3 class="text-xl font-bold">${card.name || 'N/A'}</h3>
                <p class="text-sm text-gray-400">${card.title || 'N/A'}</p>
                <p class="text-sm text-gray-400 mt-1">${card.company || 'N/A'}</p>
                <hr class="my-3 border-gray-600">
                <ul class="space-y-2 text-sm">
                    <li><span class="font-bold">Phone:</span> ${card.phone || 'N/A'}</li>
                    <li><span class="font-bold">Email:</span> ${card.email || 'N/A'}</li>
                    <li><span class="font-bold">Website:</span> ${card.website || 'N/A'}</li>
                    <li><span class="font-bold">LinkedIn:</span> ${linkedinLink}</li>
                </ul>
            `;
            container.appendChild(cardElement);
        }

        function renderExtractedData(data) {
            const linkedinLink = data.linkedin ? `<a href="${data.linkedin}" target="_blank" class="text-blue-400 hover:underline">${data.linkedin}</a>` : 'N/A';
            cardDetailsContainer.innerHTML = `
                <div class="space-y-3">
                    <div class="flex flex-col"><label class="font-bold">Name:</label><input type="text" class="rounded-md p-2 text-black" id="editName" value="${data.name || ''}"></div>
                    <div class="flex flex-col"><label class="font-bold">Company:</label><input type="text" class="rounded-md p-2 text-black" id="editCompany" value="${data.company || ''}"></div>
                    <div class="flex flex-col"><label class="font-bold">Title:</label><input type="text" class="rounded-md p-2 text-black" id="editTitle" value="${data.title || ''}"></div>
                    <div class="flex flex-col"><label class="font-bold">Phone:</label><input type="text" class="rounded-md p-2 text-black" id="editPhone" value="${data.phone || ''}"></div>
                    <div class="flex flex-col"><label class="font-bold">Email:</label><input type="text" class="rounded-md p-2 text-black" id="editEmail" value="${data.email || ''}"></div>
                    <div class="flex flex-col"><label class="font-bold">Website:</label><input type="text" class="rounded-md p-2 text-black" id="editWebsite" value="${data.website || ''}"></div>
                    <div class="flex flex-col"><label class="font-bold">LinkedIn:</label><input type="text" class="rounded-md p-2 text-black" id="editLinkedIn" value="${data.linkedin || ''}"></div>
                    <div class="flex flex-col"><label class="font-bold">Notes:</label><textarea class="rounded-md p-2 text-black" id="editNotes" rows="3"></textarea></div>
                </div>
            `;
            // Add a simple edit functionality
            extractedCardData = data;
        }

        // --- API and Tool Call Functions ---
        async function extractCardDetails(base64Image) {
            loadingIndicator.classList.remove('hidden');
            loadingMessage.textContent = 'Analyzing card...';
            extractedDataSection.classList.add('hidden');
            
            const prompt = `Extract the following details from this business card image in a JSON format. The JSON should have the following keys: "name", "title", "company", "address", "phone", "email", and "website". If a detail is not present, use an empty string for its value.`;
            
            const payload = {
                contents: [{
                    parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64Image } }]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "name": { "type": "STRING" },
                            "title": { "type": "STRING" },
                            "company": { "type": "STRING" },
                            "address": { "type": "STRING" },
                            "phone": { "type": "STRING" },
                            "email": { "type": "STRING" },
                            "website": { "type": "STRING" }
                        }
                    }
                }
            };
            
            const response = await makeApiCall(API_URL, payload);

            if (response && response.candidates && response.candidates.length > 0) {
                try {
                    const jsonResponse = JSON.parse(response.candidates[0].content.parts[0].text);
                    
                    loadingMessage.textContent = 'Searching for LinkedIn...';
                    const linkedinUrl = await searchForLinkedIn(jsonResponse.name, jsonResponse.company);
                    jsonResponse.linkedin = linkedinUrl || '';

                    loadingIndicator.classList.add('hidden');
                    renderExtractedData(jsonResponse);
                    extractedDataSection.classList.remove('hidden');
                    extractedCardData = jsonResponse;

                } catch (error) {
                    console.error("Failed to process API response:", error);
                    showMessage('Failed to extract data. Please try another image.', 'error');
                    loadingIndicator.classList.add('hidden');
                }
            } else {
                loadingIndicator.classList.add('hidden');
                showMessage('No data was extracted. Please try again.', 'error');
            }
        }

        async function searchForLinkedIn(name, company) {
            if (!name || !company) return '';
            
            const searchQuery = `${name} ${company} linkedin profile`;
            
            const toolPayload = { queries: [searchQuery] };
            const searchResponse = await makeToolCall('google_search.search', toolPayload);
            
            try {
                const searchResults = JSON.parse(searchResponse);
                if (searchResults && searchResults.results) {
                    for (const result of searchResults.results) {
                        if (result.url && result.url.includes('linkedin.com/in/')) {
                            return result.url;
                        }
                    }
                }
            } catch (error) {
                console.error("Failed to parse search results:", error);
            }
            return '';
        }

        async function makeApiCall(url, payload) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                return await response.json();
            } catch (error) {
                console.error("API call failed:", error);
                showMessage('API call failed. Please try again later.', 'error');
                return null;
            }
        }

        async function makeToolCall(toolName, payload) {
             const toolCode = `print(${toolName}(${JSON.stringify(payload)}))`;
             try {
                const response = await fetch('/tool_code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: toolCode })
                });
                return await response.text();
             } catch (error) {
                 console.error("Tool call error:", error);
                 return null;
             }
        }

        // --- Event Listeners ---
        scanFab.addEventListener('click', () => setView('scan'));
        viewFavoritesBtn.addEventListener('click', () => setView('favorites'));
        viewFoldersBtn.addEventListener('click', () => setView('folders'));
        backFromFavoritesBtn.addEventListener('click', () => setView('dashboard'));
        backFromFoldersBtn.addEventListener('click', () => setView('dashboard'));
        cancelScanBtn.addEventListener('click', () => setView('dashboard'));
        
        imageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64Image = reader.result.split(',')[1];
                    extractCardDetails(base64Image);
                };
                reader.readAsDataURL(file);
            }
        });

        saveCardBtn.addEventListener('click', async () => {
            if (!userId) return showMessage('User not authenticated.', 'error');
            
            // Get edited values from input fields
            const editedCard = {
                ...extractedCardData,
                name: document.getElementById('editName').value,
                company: document.getElementById('editCompany').value,
                title: document.getElementById('editTitle').value,
                phone: document.getElementById('editPhone').value,
                email: document.getElementById('editEmail').value,
                website: document.getElementById('editWebsite').value,
                linkedin: document.getElementById('editLinkedIn').value,
                notes: document.getElementById('editNotes').value,
                createdAt: new Date(),
                isFavorite: false
            };

            const cardsCollection = collection(db, `artifacts/${appId}/users/${userId}/cards`);
            try {
                await addDoc(cardsCollection, editedCard);
                showMessage('Card saved successfully!', 'success');
                setView('dashboard');
            } catch (error) {
                console.error("Error saving card:", error);
                showMessage('Failed to save card.', 'error');
            }
        });

        document.addEventListener('click', async (e) => {
            if (e.target.closest('.favorite-btn')) {
                const btn = e.target.closest('.favorite-btn');
                const cardId = btn.dataset.id;
                const isFavorite = btn.dataset.isfavorite === 'true';
                
                const cardRef = doc(db, `artifacts/${appId}/users/${userId}/cards`, cardId);
                try {
                    await setDoc(cardRef, { isFavorite: !isFavorite }, { merge: true });
                    showMessage(isFavorite ? 'Removed from favorites.' : 'Added to favorites.', 'success');
                } catch (error) {
                    console.error("Error toggling favorite:", error);
                    showMessage('Failed to update favorite status.', 'error');
                }
            }
        });
        
        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.className = `message-box show ${type === 'success' ? 'success' : 'error'}`;
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000);
        }

        // --- Phone Auth Logic ---
        sendOtpBtn.addEventListener('click', async () => {
            const phoneNumber = phoneNumberInput.value;
            if (phoneNumber) {
                try {
                    // Initialize reCAPTCHA verifier for phone auth
                    const recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
                        'size': 'invisible',
                        'callback': (response) => {
                            // reCAPTCHA solved, allows the OTP to be sent
                            // You can optionally do something here
                        }
                    });
                    
                    confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, recaptchaVerifier);
                    showMessage('OTP sent successfully!', 'success');
                    phoneInputContainer.classList.add('hidden');
                    otpInputContainer.classList.remove('hidden');
                } catch (error) {
                    console.error("Error sending OTP:", error);
                    showMessage('Failed to send OTP. Please try again.', 'error');
                }
            } else {
                showMessage('Please enter a valid phone number.', 'error');
            }
        });

        verifyOtpBtn.addEventListener('click', async () => {
            const otp = otpInput.value;
            if (otp) {
                try {
                    await confirmationResult.confirm(otp);
                    // onAuthStateChanged will handle the view transition
                } catch (error) {
                    console.error("Error verifying OTP:", error);
                    showMessage('Invalid OTP. Please try again.', 'error');
                }
            } else {
                showMessage('Please enter the OTP.', 'error');
            }
        });

        // --- Initial Call ---
        initializeFirebase();
        
    </script>
</body>
</html>
